<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://www.elcodi.io/book/cart-architecture/">
        <link rel="shortcut icon" href="../../img/favicon.ico">

        <title>Cart architecture - Elcodi Documentation</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">

        <link href="../../css/elcodi.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="../.."><img src="../../img/elcodi.png" height="30" /></a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                
                
                
                    
                        <li >
                            <a href="../../quick-start/">Quick start</a>
                        </li>
                    
                
                
                
                    
                        <li class="dropdown active">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Book <b class="caret"></b></a>
                            <ul class="dropdown-menu">
                            
                                
<li class="active">
    <a href="./">Cart architecture</a>
</li>

                            
                                
<li >
    <a href="../dictionary/">Dictionary</a>
</li>

                            
                                
<li >
    <a href="../emails/">Emails</a>
</li>

                            
                                
<li >
    <a href="../events/">Events</a>
</li>

                            
                                
<li >
    <a href="../">Home</a>
</li>

                            
                                
<li >
    <a href="../payments/">Payments</a>
</li>

                            
                                
<li >
    <a href="../philosophy/">Philosophy</a>
</li>

                            
                                
<li >
    <a href="../plugins/">Plugins</a>
</li>

                            
                                
<li >
    <a href="../processes/">Processes</a>
</li>

                            
                                
<li >
    <a href="../product-architecture/">Product architecture</a>
</li>

                            
                                
<li >
    <a href="../pull-requests/">Pull requests</a>
</li>

                            
                                
<li >
    <a href="../running-test-suite/">Running test suite</a>
</li>

                            
                                
<li >
    <a href="../shipping/">Shipping</a>
</li>

                            
                                
<li >
    <a href="../standards/">Standards</a>
</li>

                            
                                
<li >
    <a href="../what-is-elcodi/">What is elcodi</a>
</li>

                            
                                
<li >
    <a href="../why-elcodi/">Why elcodi</a>
</li>

                            
                            </ul>
                        </li>
                    
                
                
                
                    
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Cookbook <b class="caret"></b></a>
                            <ul class="dropdown-menu">
                            
                                
<li >
    <a href="../../cookbook/">Home</a>
</li>

                            
                                
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Installation</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../cookbook/installation/install-a-plugin/">Install a plugin</a>
</li>

        
            
<li >
    <a href="../../cookbook/installation/install-dependent-bundles/">Install dependent bundles</a>
</li>

        
    </ul>
  </li>

                            
                                
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Overwrite</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../cookbook/overwrite/overwrite-a-parameter/">Overwrite a parameter</a>
</li>

        
            
<li >
    <a href="../../cookbook/overwrite/overwrite-a-service/">Overwrite a service</a>
</li>

        
            
<li >
    <a href="../../cookbook/overwrite/overwrite-an-entity/">Overwrite an entity</a>
</li>

        
    </ul>
  </li>

                            
                                
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Adapters</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../cookbook/adapters/currency-rates-populator/">Currency rates populator</a>
</li>

        
            
<li >
    <a href="../../cookbook/adapters/image-resize/">Image resize</a>
</li>

        
            
<li >
    <a href="../../cookbook/adapters/location-provider/">Location provider</a>
</li>

        
    </ul>
  </li>

                            
                                
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Implementation</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../cookbook/implementation/implement-a-collector/">Implement a collector</a>
</li>

        
            
<li >
    <a href="../../cookbook/implementation/implement-a-controller-and-a-command/">Implement a controller and a command</a>
</li>

        
            
<li >
    <a href="../../cookbook/implementation/implement-a-factory/">Implement a factory</a>
</li>

        
            
<li >
    <a href="../../cookbook/implementation/implement-a-form-type/">Implement a form type</a>
</li>

        
            
<li >
    <a href="../../cookbook/implementation/implement-a-repository/">Implement a repository</a>
</li>

        
            
<li >
    <a href="../../cookbook/implementation/implement-an-entity/">Implement an entity</a>
</li>

        
            
<li >
    <a href="../../cookbook/implementation/implement-an-event-listener/">Implement an event listener</a>
</li>

        
    </ul>
  </li>

                            
                            </ul>
                        </li>
                    
                
                
                
                    
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Component <b class="caret"></b></a>
                            <ul class="dropdown-menu">
                            
                                
<li >
    <a href="../../component/entity-translator/">Entity translator</a>
</li>

                            
                                
<li >
    <a href="../../component/">Home</a>
</li>

                            
                                
<li >
    <a href="../../component/media/">Media</a>
</li>

                            
                                
<li >
    <a href="../../component/menu/">Menu</a>
</li>

                            
                                
<li >
    <a href="../../component/sitemap/">Sitemap</a>
</li>

                            
                                
<li >
    <a href="../../component/state-transition-machine/">State transition machine</a>
</li>

                            
                                
<li >
    <a href="../../component/template/">Template</a>
</li>

                            
                            </ul>
                        </li>
                    
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../../quick-start/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../dictionary/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
                    <li>
                        <a href="https://github.com/elcodi/docs">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#cart-architecture">Cart Architecture</a></li>
        
            <li><a href="#introduction">Introduction</a></li>
        
            <li><a href="#cart">Cart</a></li>
        
            <li><a href="#cart-line">Cart Line</a></li>
        
            <li><a href="#loading-the-cart">Loading the cart</a></li>
        
            <li><a href="#cart-transformation">Cart transformation</a></li>
        
            <li><a href="#order">Order</a></li>
        
            <li><a href="#order-states">Order states</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="cart-architecture">Cart Architecture<a class="headerlink" href="#cart-architecture" title="Permanent link"> #</a></h1>
<p>This is one of the most important parts of the whole project. How Elcodi's cart
works? How it's been designed? And how can I deal with it?</p>
<p>We will show you how we have designed all the model and why have we decided this
architecture. It is important for you to understand the design in order to
detect all possible entry and modification points, to make the Cart component as
much customized as you need.</p>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link"> #</a></h2>
<p>Let's start by determining what the Cart Component should take care about. Well,
not difficult at all, so we are working in an E-commerce. The component itself
takes care about all related to the Cart and the Order. The component provides
you a complete service layer for you application, so knowing and understanding
this layer will help you a lot in your own implementation.</p>
<p>We will split all the model in two parts, the Cart path and the Order part. Both
parts are connected but they can (and should) be treated in a very isolated way.</p>
<p><img alt="Cart component model" src="../../image/model/cart-component.png" /></p>
<p>First of all, forget about the Purchasable instance. This is just the way we
will refer to the concept of Product (please, read the 
<a href="../product-architecture/">Product Architecture</a> chapter in order to know more
about it. Let's focus on how the Cart and Order are built.</p>
<h2 id="cart">Cart<a class="headerlink" href="#cart" title="Permanent link"> #</a></h2>
<p>The bucket itself. Every customer has it's own cart, and it's life is connected
to the session and to the customer as well. This means that even if you change
the device, and as long as you're logged in, then you will be able to retrieve
the cart from the database.</p>
<p>Some parts of the cart are not stored in database, like the prices. Because of
some products from your cart can be disabled between page views, or because
their prices can be modified as well, every time you request your cart, prices
are reloaded and saved locally, in your object life. Of course, this means two
things:</p>
<ul>
<li>Your cart loading consumes some resources in each request</li>
<li>You cannot lookup in your database by these values</li>
</ul>
<p>Anyway, this strategy helps a lot in your stored carts status. This means that
you will not store invalid prices.</p>
<p>The Cart model introduces a new object called Cart Line.</p>
<h2 id="cart-line">Cart Line<a class="headerlink" href="#cart-line" title="Permanent link"> #</a></h2>
<p>Everytime a new purchasable object is added into a Cart, you must save, at
least, one extra information about this relation (cart and purchasable): the
quantity. Because of this, you cannot relate directly both elements. Of course,
if the purchasable object needs more information about the relation, for example
color, size or any single text, you should save them all as well.</p>
<p>For this, we will work with an extra man-in-the-middle class called CartLine. In
this class we'll save the Cart, the purchasable object and all this information.
CartLine is designed using
<a href="https://en.wikipedia.org/wiki/Object_composition">Object Composition</a>. It means
that the life of all CartLine instances are coupled to the life of the Cart
instance.</p>
<p><img alt="Cart model" src="../../image/model/cart-cartline.png" /></p>
<h2 id="loading-the-cart">Loading the cart<a class="headerlink" href="#loading-the-cart" title="Permanent link"> #</a></h2>
<p>As we said, the cart is loaded each time, but, who loads it? In fact, and
because of our service layer, you will find that loading cart is as easy as
using an event dispatcher called <code>elcodi.event_dispatcher.cart</code>.</p>
<pre><code class="php">$cart = $this
    -&gt;cartRepository
    -&gt;find(1);

$this
    -&gt;cartEventDispatcher
    -&gt;dispatchCartLoadEvents($cart);
</code></pre>

<p>Let's check as well how to inject the event listener. In that case we are
injecting both the event dispatcher and the cart repository, for cart
retrieving.</p>
<pre><code class="yaml">services:
    my_cart_loader:
        class: My\Cart\Loader\Class
        arguments:
            - @elcodi.repository.cart
            - @elcodi.event_dispatcher.cart
</code></pre>

<p>After that call, your cart will be completely loaded, including prices and
checks, and invalid cart lines will be safely removed. Of course, and because
the project uses a strong event layer, some events will be dispatched during the
process.</p>
<ul>
<li><a href="../events/#cartpreload">cart.preload</a></li>
<li><a href="../events/#cartonload">cart.onload</a></li>
<li><a href="../events/#cartinconsistent">cart.inconsistent</a></li>
</ul>
<p>The question then is... how can I know that a cart has been loaded? Well, easy
indeed.</p>
<pre><code class="php">$cart = $this
    -&gt;cartRepository
    -&gt;find(1);

$isLoaded = $cart-&gt;isLoaded();
// $isLoaded === false

$this
    -&gt;cartEventDispatcher
    -&gt;dispatchCartLoadEvents($cart);

$isLoaded = $cart-&gt;isLoaded();
// $isLoaded === true
</code></pre>

<h2 id="cart-transformation">Cart transformation<a class="headerlink" href="#cart-transformation" title="Permanent link"> #</a></h2>
<p>Once the cart must be converted to an order, there is a nice transformer for
that occasion. Let's see an example of that transformation. In that occasion, we
assume that <code>getLoadedCart()</code> returns an already loaded cart.</p>
<pre><code class="php">$cart = $this-&gt;getLoadedCart();

$order = $this
    -&gt;cartOrderTransformer
    -&gt;createOrderFromCart($cart);
</code></pre>

<p>This action produces as well some new events.</p>
<ul>
<li><a href="../events/#orderprecreated">order.precreated</a></li>
<li><a href="../events/#orderoncreated">order.oncreated</a></li>
<li><a href="../events/#orderlineoncreated">order_line.oncreated</a></li>
</ul>
<p>After this action, the cart becomes ordered</p>
<pre><code class="php">$cart = $this-&gt;getLoadedCart();

$order = $this
    -&gt;cartOrderTransformer
    -&gt;createOrderFromCart($cart);

$cartIsOrdered = $cart-&gt;isOrdered();
// $cartIsOrdered === true
</code></pre>

<h2 id="order">Order<a class="headerlink" href="#order" title="Permanent link"> #</a></h2>
<p>The order should always be a plain copy of a cart. Of course, and because the
object's behaviour should be as immutable as possible, all prices are calculated
and saved in database.</p>
<p><img alt="Order model" src="../../image/model/order-orderline.png" /></p>
<p>Inside the entity, you will find this information:</p>
<ul>
<li>Cart where the order belongs</li>
<li>Dimensions of the order (only physical orders)</li>
<li>OrderLines, each one as a mirror of each CartLine</li>
<li>Quantity of the order, total number of elements</li>
<li>Prices from products, coupons, shipping and total.</li>
<li>Addresses from delivering and billing</li>
<li>Order States</li>
</ul>
<h2 id="order-states">Order states<a class="headerlink" href="#order-states" title="Permanent link"> #</a></h2>
<p>When an order is created, each instance can travel through an amount of
predefined states.</p>
<p>With the basic implementation, you will find defined state machines for payment
and shipping. To know more about this, please, read the <a href="../payments/">Payments</a>
and the <a href="../shipping/">Shipping</a> chapters</p></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
                <p>Copyright © 2014/2015 <a href="http://www.elcodi.io">Elcodi</a>. All rights reserved.</p>
            
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
